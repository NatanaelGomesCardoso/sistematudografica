{% extends 'base.html' %}

{% block title %}Cadastro de Clientes — Tudo Gráfica{% endblock %}
{% block page_title %}Cadastro de Novo Cliente{% endblock %}

{% block content %}
<form id="formCliente" action="{{ url_for('cadastro_clientes_post') }}" method="post" novalidate>
    <div class="form-group">
        <label>Tipo de Cadastro:</label>
        <div class="radio-group">
            <input type="radio" id="tipo_cpf" name="tipo" value="cpf" checked>
            <label for="tipo_cpf">Pessoa Física</label>

            <input type="radio" id="tipo_cnpj" name="tipo" value="cnpj">
            <label for="tipo_cnpj">Pessoa Jurídica</label>
        </div>
    </div>

    <div id="form-cpf">
        <div class="form-group">
            <label for="nome_pf">Nome completo (obrigatório)</label>
            <input type="text" name="nome" id="nome_pf">
        </div>
        <div class="form-group">
            <label for="cpf">CPF</label>
            <input type="text" name="cpf" id="cpf" placeholder="000.000.000-00">
        </div>
        <div class="form-group">
            <label for="email_pf">E-mail</label>
            <input type="email" name="email" id="email_pf">
        </div>
    </div>

    <div id="form-cnpj" style="display:none;">
        <div class="form-group">
            <label for="razao_social">Razão Social (obrigatório)</label>
            <input type="text" name="razao_social" id="razao_social">
        </div>
        <div class="form-group">
            <label for="nome_fantasia">Nome Fantasia</label>
            <input type="text" name="nome_fantasia" id="nome_fantasia">
        </div>
        <div class="form-group">
            <label for="cnpj">CNPJ (obrigatório)</label>
            <input type="text" name="cnpj" id="cnpj" placeholder="00.000.000/0000-00">
        </div>
        <div class="form-group">
            <label for="responsavel">Responsável</label>
            <input type="text" name="responsavel" id="responsavel">
        </div>
        <div class="form-group">
            <label for="email_cnpj">E-mail da empresa</label>
            <input type="email" name="email_cnpj" id="email_cnpj">
        </div>
    </div>

    <div class="form-group">
        <label for="telefone">Telefone (Whatsapp) (obrigatório)</label>
        <input type="text" name="telefone" id="telefone" value="+55 79 9">
    </div>

    <div class="form-group">
        <label for="como_conheceu">Como conheceu a empresa?</label>
        <select name="como_conheceu" id="como_conheceu">
            <option value="Google">Google</option>
            <option value="Facebook">Facebook</option>
            <option value="Instagram">Instagram</option>
            <option value="Indicação">Indicação</option>
            <option value="Prospecção direta">Prospecção direta</option>
            <option value="Outros">Outros</option>
        </select>
        <input type="text" name="como_conheceu_outros" id="campo_outros" style="display:none;"
            placeholder="Descreva aqui...">
    </div>

    <button type="submit" class="btn-salvar">Salvar Cliente</button>
</form>

{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<script>
    // Funções de validação de CPF e CNPJ (iguais às de antes)
    function validarCPF(cpf) { /* ...código de validação de CPF... */ }
    function validarCNPJ(cnpj) { /* ...código de validação de CNPJ... */ }
    // Cole as funções completas que te passei antes aqui para economizar espaço na resposta

    $(document).ready(function () {
        // --- MÁSCARAS ---
        $('#telefone').mask('+00 00 00000-0000');
        $('#cpf').mask('000.000.000-00');
        $('#cnpj').mask('00.000.000/0000-00');

        // --- INTERATIVIDADE DO FORMULÁRIO ---
        function alternarFormulario() {
            if ($('#tipo_cpf').is(':checked')) {
                $('#form-cpf').show();
                $('#form-cnpj').hide();
            } else {
                $('#form-cpf').hide();
                $('#form-cnpj').show();
            }
        }

        $('input[name="tipo"]').on('change', alternarFormulario);
        alternarFormulario(); // Executa ao carregar a página

        $('#como_conheceu').on('change', function () {
            if ($(this).val() === 'Outros') {
                $('#campo_outros').show();
            } else {
                $('#campo_outros').hide();
            }
        });

        // --- VALIDAÇÃO NO ENVIO ---
        $('#formCliente').on('submit', function (e) {
            $('input').removeClass('input-error');
            let isValid = true;

            // Valida Telefone (obrigatório e completo)
            const telefone = $('#telefone').val();
            if (telefone.length !== 19) {
                alert('O campo Telefone é obrigatório e deve ser preenchido completamente.');
                $('#telefone').addClass('input-error');
                isValid = false;
            }

            // Validação para Pessoa Física
            if ($('#tipo_cpf').is(':checked')) {
                const nome = $('#nome_pf').val();
                if (nome.length <= 3) {
                    alert('O campo Nome é obrigatório e deve ter mais de 3 letras.');
                    $('#nome_pf').addClass('input-error');
                    isValid = false;
                }
                const cpf = $('#cpf').val();
                if (cpf && !validarCPF(cpf)) {
                    alert('O CPF digitado é inválido.');
                    $('#cpf').addClass('input-error');
                    isValid = false;
                }
            }
            // Validação para Pessoa Jurídica
            else {
                if ($('#razao_social').val().length <= 3) {
                    alert('O campo Razão Social é obrigatório e deve ter mais de 3 letras.');
                    $('#razao_social').addClass('input-error');
                    isValid = false;
                }
                const cnpj = $('#cnpj').val();
                if (!cnpj) {
                    alert('O campo CNPJ é obrigatório.');
                    $('#cnpj').addClass('input-error');
                    isValid = false;
                } else if (!validarCNPJ(cnpj)) {
                    alert('O CNPJ digitado é inválido.');
                    $('#cnpj').addClass('input-error');
                    isValid = false;
                }
            }

            if (!isValid) {
                e.preventDefault(); // Bloqueia o envio se algo estiver errado
            }
        });
    });
</script>
{% endblock %}