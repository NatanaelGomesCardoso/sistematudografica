{% extends 'base.html' %}

{% block title %}Cadastro de Clientes — Tudo Gráfica{% endblock %}

{% block content %}
<h2>Cadastro de Cliente</h2>

<form id="formCliente" action="{{ url_for('cadastro_clientes_post') }}" method="post">
    <!-- Tipo de pessoa -->
    <div class="form-group">
        <label>Tipo de Cadastro:</label><br>
        <div class="radio-group">
            <input type="radio" id="tipo_cpf" name="tipo" value="cpf" checked onchange="alternarFormulario()">
            <label for="tipo_cpf">Pessoa Física</label>

            <input type="radio" id="tipo_cnpj" name="tipo" value="cnpj" onchange="alternarFormulario()">
            <label for="tipo_cnpj">Pessoa Jurídica</label>
        </div>
    </div>

    <!-- Pessoa Física -->
    <div id="form-cpf">
        <div class="form-group">
            <label>Nome completo:</label>
            <input type="text" name="nome" required>
        </div>
        <div class="form-group">
            <label>CPF:</label>
            <input type="text" name="cpf" id="cpf">
        </div>
        <div class="form-group">
            <label>E-mail:</label>
            <input type="email" name="email" required>
        </div>
    </div>

    <!-- Pessoa Jurídica -->
    <div id="form-cnpj" style="display:none;">
        <div class="form-group">
            <label>Razão Social:</label>
            <input type="text" name="razao_social">
        </div>
        <div class="form-group">
            <label>Nome Fantasia:</label>
            <input type="text" name="nome_fantasia">
        </div>
        <div class="form-group">
            <label>CNPJ:</label>
            <input type="text" name="cnpj" id="cnpj">
        </div>
        <div class="form-group">
            <label>Responsável:</label>
            <input type="text" name="responsavel">
        </div>
        <div class="form-group">
            <label>Telefone da empresa:</label>
            <input type="text" name="telefone_empresa">
        </div>
        <div class="form-group">
            <label>E-mail:</label>
            <input type="email" name="email_cnpj" required>
        </div>
        <div class="form-group">
            <label>Endereço:</label>
            <input type="text" name="endereco_empresa">
        </div>
        <div class="form-group">
            <label>Endereço de entrega:</label>
            <input type="text" name="endereco_entrega">
        </div>
    </div>

    <!-- Telefone -->
    <div class="form-group">
        <label>Telefone (Whatsapp):</label>
        <input type="text" name="telefone" id="telefone" value="+55 79 9" required>
    </div>

    <!-- Como conheceu -->
    <div class="form-group">
        <label>Como conheceu a empresa?</label>
        <select name="como_conheceu" id="como_conheceu" onchange="mostrarCampoOutro()">
            <option value="Google">Google</option>
            <option value="Facebook">Facebook</option>
            <option value="Instagram">Instagram</option>
            <option value="Indicação">Indicação</option>
            <option value="Prospecção direta">Prospecção direta</option>
            <option value="Outros">Outros</option>
        </select>
        <input type="text" name="como_conheceu_outros" id="campo_outros" style="display:none;"
            placeholder="Descreva aqui...">
    </div>

    <button type="submit">Salvar Cliente</button>
</form>

<hr>

<h3>Clientes cadastrados</h3>
<table class="clientes-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>E-mail</th>
            <th>Telefone</th>
            <th>Como conheceu</th>
        </tr>
    </thead>
    <tbody>
        {% for cliente in clientes %}
        <tr>
            <td>{{ cliente.id }}</td>
            <td>{{ cliente.nome }}</td>
            <td>{{ cliente.email }}</td>
            <td>{{ cliente.telefone }}</td>
            <td>{{ cliente.como_conheceu }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
    function alternarFormulario() {
        const tipo = document.querySelector('input[name="tipo"]:checked').value;
        document.getElementById('form-cpf').style.display = tipo === 'cpf' ? 'block' : 'none';
        document.getElementById('form-cnpj').style.display = tipo === 'cnpj' ? 'block' : 'none';
    }

    function mostrarCampoOutro() {
        const select = document.getElementById('como_conheceu');
        const campo = document.getElementById('campo_outros');
        campo.style.display = select.value === 'Outros' ? 'block' : 'none';
    }

    // Máscaras
    $(document).ready(function () {
        $('#telefone').mask('+00 00 00000-0000');
        $('#cpf').mask('000.000.000-00');
        $('#cnpj').mask('00.000.000/0000-00');
    });

    // Validação simples de CPF
    function validarCPF(cpf) {
        cpf = cpf.replace(/[^\d]+/g, '');
        if (cpf.length !== 11) return false;
        if (/^(\d)\1+$/.test(cpf)) return false;
        let soma = 0;
        for (let i = 0; i < 9; i++) soma += parseInt(cpf.charAt(i)) * (10 - i);
        let resto = 11 - (soma % 11);
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf.charAt(9))) return false;
        soma = 0;
        for (let i = 0; i < 10; i++) soma += parseInt(cpf.charAt(i)) * (11 - i);
        resto = 11 - (soma % 11);
        if (resto === 10 || resto === 11) resto = 0;
        return resto === parseInt(cpf.charAt(10));
    }

    // Validação simples de CNPJ
    function validarCNPJ(cnpj) {
        cnpj = cnpj.replace(/[^\d]+/g, '');
        if (cnpj.length !== 14) return false;
        if (/^(\d)\1+$/.test(cnpj)) return false;
        let t = cnpj.length - 2,
            d = cnpj.substring(t),
            d1 = parseInt(d.charAt(0)),
            d2 = parseInt(d.charAt(1)),
            calc = x => {
                let n = 0;
                for (let i = 0; i < x; i++) {
                    n += parseInt(cnpj.charAt(i)) * ((x + 1 - i) % 8 + 2);
                }
                return (n % 11 < 2 ? 0 : 11 - n % 11);
            };
        return calc(t) === d1 && calc(t + 1) === d2;
    }

    // Bloqueia envio se CPF/CNPJ inválido
    $('#formCliente').on('submit', function (e) {
        const tipo = $('input[name=tipo]:checked').val();
        if (tipo === 'cpf') {
            const cpf = $('#cpf').val();
            if (!validarCPF(cpf)) {
                alert('CPF inválido!');
                e.preventDefault();
            }
        } else {
            const cnpj = $('#cnpj').val();
            if (!validarCNPJ(cnpj)) {
                alert('CNPJ inválido!');
                e.preventDefault();
            }
        }
    });
</script>
{% endblock %}