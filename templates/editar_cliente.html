{% extends 'base.html' %}

{% block title %}Editar Cliente — Tudo Gráfica{% endblock %}
{% block page_title %}Editando Cliente: {{ cliente.nome or cliente.razao_social }}{% endblock %}

{% block content %}
<form id="formCliente" action="{{ url_for('editar_cliente', id=cliente.id) }}" method="post" novalidate>
    <div class="form-group">
        <label>Tipo de Cadastro</label>
        <div class="radio-group">
            <input type="radio" id="tipo_cpf" name="tipo" value="cpf" {% if cliente.tipo=='cpf' %}checked{% endif %}>
            <label for="tipo_cpf">Pessoa Física</label>
            <input type="radio" id="tipo_cnpj" name="tipo" value="cnpj" {% if cliente.tipo=='cnpj' %}checked{% endif %}>
            <label for="tipo_cnpj">Pessoa Jurídica</label>
        </div>
    </div>

    <hr style="border: none; border-top: 1px solid #eee; margin: 2rem 0;">

    <div id="form-cpf">
        <div class="form-group">
            <label for="nome_pf">Nome completo <span class="label-note">*obrigatório</span></label>
            <input type="text" name="nome" id="nome_pf" value="{{ cliente.nome or '' }}">
            <div class="error-message"></div>
        </div>
        <div class="form-group">
            <label for="telefone_pf">Telefone (Whatsapp) <span class="label-note">*obrigatório</span></label>
            <input type="text" name="telefone" id="telefone_pf" class="telefone-input"
                value="{{ cliente.telefone or '' }}">
            <div class="error-message"></div>
        </div>
        <div class="form-group">
            <label for="como_conheceu_pf">Como conheceu a empresa? <span class="label-note">*obrigatório</span></label>
            <select name="como_conheceu" id="como_conheceu_pf" class="como-conheceu-select">
                <option value="" {% if not cliente.como_conheceu %}selected{% endif %}>Selecione uma opção</option>
                <option value="Google" {% if cliente.como_conheceu=='Google' %}selected{% endif %}>Google</option>
                <option value="Facebook" {% if cliente.como_conheceu=='Facebook' %}selected{% endif %}>Facebook</option>
                <option value="Instagram" {% if cliente.como_conheceu=='Instagram' %}selected{% endif %}>Instagram
                </option>
                <option value="Indicação" {% if cliente.como_conheceu=='Indicação' %}selected{% endif %}>Indicação
                </option>
                <option value="Prospecção direta" {% if cliente.como_conheceu=='Prospecção direta' %}selected{% endif
                    %}>Prospecção direta</option>
                <option value="Outros" {% if cliente.como_conheceu=='Outros' %}selected{% endif %}>Outros</option>
            </select>
            <div class="error-message"></div>
            <input type="text" name="como_conheceu_outros" value="{{ cliente.como_conheceu_outros or '' }}"
                class="como-conheceu-outros" style="display:none; margin-top: 1rem;"
                placeholder="Descreva com mais de 3 letras">
        </div>
        <div class="form-group">
            <label for="cpf">CPF <span class="label-note">(opcional)</span></label>
            <input type="text" name="cpf" id="cpf" placeholder="000.000.000-00" value="{{ cliente.cpf or '' }}">
            <div class="error-message"></div>
        </div>
        <div class="form-group">
            <label for="email_pf">E-mail <span class="label-note">(opcional)</span></label>
            <input type="email" name="email" id="email_pf" value="{{ cliente.email or '' }}">
            <div class="error-message"></div>
        </div>
    </div>

    <div id="form-cnpj" style="display:none;">
        <div class="form-group">
            <label for="razao_social">Razão Social <span class="label-note">*obrigatório</span></label>
            <input type="text" name="razao_social" id="razao_social" value="{{ cliente.razao_social or '' }}">
            <div class="error-message"></div>
        </div>
        <div class="form-group">
            <label for="responsavel">Nome do responsável <span class="label-note">*obrigatório</span></label>
            <input type="text" name="responsavel" id="responsavel" value="{{ cliente.responsavel or '' }}">
            <div class="error-message"></div>
        </div>
        <div class="form-group">
            <label for="telefone_pj">Telefone do responsável <span class="label-note">*obrigatório</span></label>
            <input type="text" name="telefone" id="telefone_pj" class="telefone-input"
                value="{{ cliente.telefone or '' }}">
            <div class="error-message"></div>
        </div>
        <div class="form-group">
            <label for="cnpj">CNPJ <span class="label-note">*obrigatório</span></label>
            <input type="text" name="cnpj" id="cnpj" placeholder="00.000.000/0000-00" value="{{ cliente.cnpj or '' }}">
            <div class="error-message"></div>
        </div>
        <div class="form-group">
            <label for="como_conheceu_pj">Como conheceu a empresa? <span class="label-note">*obrigatório</span></label>
            <select name="como_conheceu" id="como_conheceu_pj" class="como-conheceu-select">
                <option value="" {% if not cliente.como_conheceu %}selected{% endif %}>Selecione uma opção</option>
                <option value="Google" {% if cliente.como_conheceu=='Google' %}selected{% endif %}>Google</option>
                <option value="Facebook" {% if cliente.como_conheceu=='Facebook' %}selected{% endif %}>Facebook</option>
                <option value="Instagram" {% if cliente.como_conheceu=='Instagram' %}selected{% endif %}>Instagram
                </option>
                <option value="Indicação" {% if cliente.como_conheceu=='Indicação' %}selected{% endif %}>Indicação
                </option>
                <option value="Prospecção direta" {% if cliente.como_conheceu=='Prospecção direta' %}selected{% endif
                    %}>Prospecção direta</option>
                <option value="Outros" {% if cliente.como_conheceu=='Outros' %}selected{% endif %}>Outros</option>
            </select>
            <div class="error-message"></div>
            <input type="text" name="como_conheceu_outros" value="{{ cliente.como_conheceu_outros or '' }}"
                class="como-conheceu-outros" style="display:none; margin-top: 1rem;"
                placeholder="Descreva com mais de 3 letras">
        </div>
        <div class="form-group">
            <label for="telefone_empresa">Telefone da Empresa <span class="label-note">(opcional)</span></label>
            <input type="text" name="telefone_empresa" id="telefone_empresa" class="telefone-input"
                value="{{ cliente.telefone_empresa or '' }}">
        </div>
        <div class="form-group">
            <label for="email_cnpj">E-mail da empresa <span class="label-note">(opcional)</span></label>
            <input type="email" name="email_cnpj" id="email_cnpj" value="{{ cliente.email_cnpj or '' }}">
            <div class="error-message"></div>
        </div>
    </div>

    <button type="submit" class="btn-salvar">Salvar Alterações</button>
</form>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
    function validarCPF(cpf) { cpf = cpf.replace(/[^\d]+/g, ''); if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false; let s = 0, r; for (let i = 1; i <= 9; i++) s += parseInt(cpf.substring(i - 1, i)) * (11 - i); r = (s * 10) % 11; if ((r === 10) || (r === 11)) r = 0; if (r !== parseInt(cpf.substring(9, 10))) return false; s = 0; for (let i = 1; i <= 10; i++) s += parseInt(cpf.substring(i - 1, i)) * (12 - i); r = (s * 10) % 11; if ((r === 10) || (r === 11)) r = 0; return r === parseInt(cpf.substring(10, 11)); }
    function validarCNPJ(cnpj) { cnpj = cnpj.replace(/[^\d]+/g, ''); if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false; let t = cnpj.length - 2, n = cnpj.substring(0, t), d = cnpj.substring(t), s = 0, p = t - 7; for (let i = t; i >= 1; i--) { s += n.charAt(t - i) * p--; if (p < 2) p = 9; } let r = s % 11 < 2 ? 0 : 11 - s % 11; if (r != d.charAt(0)) return false; t = t + 1; n = cnpj.substring(0, t); s = 0; p = t - 7; for (let i = t; i >= 1; i--) { s += n.charAt(t - i) * p--; if (p < 2) p = 9; } r = s % 11 < 2 ? 0 : 11 - s % 11; return r == d.charAt(1); }
    function validarEmail(email) { const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/; return re.test(String(email).toLowerCase()); }

    $(document).ready(function () {
        $('.telefone-input').mask('+00 00 9 0000-0000');
        $('#cpf').mask('000.000.000-00');
        $('#cnpj').mask('00.000.000/0000-00');

        function alternarFormulario() {
            let is_cpf = $('#tipo_cpf').is(':checked');
            $('#form-cpf').toggle(is_cpf);
            $('#form-cnpj').toggle(!is_cpf);

            // Habilita/desabilita campos para garantir que apenas os dados do form visível sejam enviados
            $('#form-cpf').find('input, select').prop('disabled', !is_cpf);
            $('#form-cnpj').find('input, select').prop('disabled', is_cpf);
        }
        $('input[name="tipo"]').on('change', alternarFormulario);
        alternarFormulario();

        $('.como-conheceu-select').on('change', function () {
            $(this).closest('.form-group').find('.como-conheceu-outros').toggle($(this).val() === 'Outros');
        });

        // --- VALIDAÇÃO REIMAGINADA ---
        function validateForm() {
            let isValid = true;
            $('.error-message').text('');
            $('input, select').removeClass('input-error');

            function setError(element, message) {
                element.addClass('input-error');
                element.closest('.form-group').find('.error-message').text(message);
                isValid = false;
            }

            if ($('#tipo_cpf').is(':checked')) {
                // --- Regras OBRIGATÓRIAS para Pessoa Física ---
                if ($('#nome_pf').val().trim().length <= 3) setError($('#nome_pf'), 'O nome deve ter mais de 3 letras.');
                if ($('#telefone_pf').mask().val().replace(/[^\d]/g, '').length < 13) setError($('#telefone_pf'), 'Preencha o telefone completamente.');
                if ($('#como_conheceu_pf').val() === "") setError($('#como_conheceu_pf'), 'Este campo é obrigatório.');
                if ($('#como_conheceu_pf').val() === "Outros" && $('#como_conheceu_pf').closest('.form-group').find('.como-conheceu-outros').val().trim().length <= 3) {
                    setError($('#como_conheceu_pf').closest('.form-group').find('.como-conheceu-outros'), 'Descreva com mais de 3 letras.');
                }

                // --- Regras OPCIONAIS (só valida se preenchido) ---
                const cpf = $('#cpf').val();
                if (cpf && !validarCPF(cpf)) setError($('#cpf'), 'Este CPF é inválido.');
                const email_pf = $('#email_pf').val();
                if (email_pf && !validarEmail(email_pf)) setError($('#email_pf'), 'Formato de e-mail inválido.');
            } else {
                // --- Regras OBRIGATÓRIAS para Pessoa Jurídica ---
                if ($('#razao_social').val().trim().length <= 3) setError($('#razao_social'), 'A razão social deve ter mais de 3 letras.');
                if ($('#responsavel').val().trim().length <= 3) setError($('#responsavel'), 'O nome do responsável deve ter mais de 3 letras.');
                if ($('#telefone_pj').mask().val().replace(/[^\d]/g, '').length < 13) setError($('#telefone_pj'), 'Preencha o telefone completamente.');
                const cnpj = $('#cnpj').val();
                if (!cnpj) {
                    setError($('#cnpj'), 'O CNPJ é obrigatório.');
                } else if (!validarCNPJ(cnpj)) { setError($('#cnpj'), 'Este CNPJ é inválido.'); }
                if ($('#como_conheceu_pj').val() === "") setError($('#como_conheceu_pj'), 'Este campo é obrigatório.');
                if ($('#como_conheceu_pj').val() === "Outros" && $('#como_conheceu_pj').closest('.form-group').find('.como-conheceu-outros').val().trim().length <= 3) {
                    setError($('#como_conheceu_pj').closest('.form-group').find('.como-conheceu-outros'), 'Descreva com mais de 3 letras.');
                }
            }
            return isValid;
        }

        $('#formCliente').on('submit', function (e) {
            alternarFormulario(); // Garante que apenas os campos certos estão habilitados
            if (!validateForm()) {
                e.preventDefault(); // Bloqueia o envio do formulário se for inválido
            }
        });
    });
</script>
{% endblock %}